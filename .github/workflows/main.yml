name: build

on:
  push:
    branches:
      - 'master'
  pull_request:
    branches:
      - '*'

jobs:
  build:
    name: ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    if: "!contains(github.event.head_commit.message, 'skip ci')"
    timeout-minutes: 20
    strategy:
      fail-fast: false
      matrix:
        # Industry standard: Ubuntu + Windows only (Microsoft skips macOS to conserve resources)
        os: [ubuntu-latest, windows-latest]

    steps:
      - name: Clone repository
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'

      - name: Install Dependencies
        run: npm ci

      - name: Install Subversion (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y subversion

      - name: Install Subversion (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: choco install svn -y

      # Consolidated checks (merged from separate jobs)
      - name: Lint check
        run: npm run lint --silent -- -f stylish

      - name: Security validation
        run: npm run security:validate-errors

      - name: Build extension
        run: npm run build

      # Fixed VSCode cache (removed github.run_id for proper cache hits)
      - name: Cache VSCode binary
        id: cache-vscode
        uses: actions/cache@v4
        with:
          path: .vscode-test
          key: vscode-${{ runner.os }}-stable-${{ hashFiles('package.json') }}
          restore-keys: |
            vscode-${{ runner.os }}-stable-
            vscode-${{ runner.os }}-

      - name: Run tests (Linux)
        if: runner.os == 'Linux'
        run: xvfb-run -a npx vscode-test
        env:
          CODE_VERSION: stable
          VSCODE_TEST_VERSION: stable
          NODE_OPTIONS: --max-old-space-size=6144

      - name: Run tests (Windows)
        if: runner.os == 'Windows'
        run: npx vscode-test
        env:
          CODE_VERSION: stable
          VSCODE_TEST_VERSION: stable
          NODE_OPTIONS: --max-old-space-size=6144

      # Release only on master + ubuntu
      - name: Release
        if: matrix.os == 'ubuntu-latest' && github.ref == 'refs/heads/master' && github.repository == 'JohnstonCode/svn-scm'
        run: |
          npm run organize
          npm run semantic-release
        env:
          VSCE_TOKEN: ${{ secrets.vsceToken }}
          GITHUB_TOKEN: ${{ secrets.githubToken }}
          GH_TOKEN: ${{ secrets.githubToken }}
          GIT_AUTHOR_EMAIL: ${{ secrets.gitEmail }}
          GIT_COMMITTER_EMAIL: ${{ secrets.gitEmail }}
          GIT_AUTHOR_NAME: ${{ secrets.gitName }}
          GIT_COMMITTER_NAME: ${{ secrets.gitName }}

  # Artifact job - only on master or tags
  artifact:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/master' || startsWith(github.ref, 'refs/tags/')
    timeout-minutes: 10

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'

      - name: Install Dependencies
        run: npm ci

      - name: Build extension
        run: npm run build

      - name: Package extension
        run: npx @vscode/vsce package -o svn-scm.vsix

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: "svn-scm-${{ github.sha }}.vsix"
          path: "svn-scm.vsix"

      - name: Package open-vsx extension
        run: |
          npm install iconv-lite
          npx @vscode/vsce package -o svn-scm-ovsx.vsix

      - name: Upload open-vsx artifact
        uses: actions/upload-artifact@v4
        with:
          name: "svn-scm-ovsx-${{ github.sha }}.vsix"
          path: "svn-scm-ovsx.vsix"
