name: CI

on:
  push:
    branches:
      - "master"
  pull_request:
    branches:
      - "*"

jobs:
  build:
    name: ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    if: "!contains(github.event.head_commit.message, 'skip ci')"
    timeout-minutes: 20
    strategy:
      fail-fast: false
      matrix:
        # Test on all platforms: Ubuntu, Windows, and macOS
        # Note: macOS included since developer uses Mac
        os: [ubuntu-latest, windows-latest, macos-latest]

    steps:
      - name: Clone repository
        uses: actions/checkout@v6

      - name: Setup Node
        uses: actions/setup-node@v6
        with:
          node-version: "20.x"
          cache: "npm"

      - name: Install Dependencies
        run: npm ci

      - name: Install Subversion (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y subversion

      - name: Install Subversion (macOS)
        if: runner.os == 'macOS'
        run: brew install subversion

      - name: Install Subversion (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: choco install svn -y

      # Consolidated checks (merged from separate jobs)
      - name: Lint check
        run: npm run lint --silent -- -f stylish
        env:
          NODE_OPTIONS: --max-old-space-size=4096

      - name: Security validation
        run: npm run security:validate-errors

      - name: Build extension
        run: npm run build

      # Fixed VSCode cache (removed github.run_id for proper cache hits)
      - name: Cache VSCode binary
        id: cache-vscode
        uses: actions/cache@v4
        with:
          path: .vscode-test
          key: vscode-${{ runner.os }}-stable-${{ hashFiles('package.json') }}
          restore-keys: |
            vscode-${{ runner.os }}-stable-
            vscode-${{ runner.os }}-

      # Unit tests with Vitest (fast, no display needed)
      - name: Run unit tests
        run: npm run test:unit

      # E2E tests with VS Code (needs display)
      - name: Run E2E tests (Linux)
        if: runner.os == 'Linux'
        run: xvfb-run -a npm run test:e2e
        env:
          CODE_VERSION: stable
          VSCODE_TEST_VERSION: stable
          NODE_OPTIONS: --max-old-space-size=6144

      - name: Run E2E tests (macOS/Windows)
        if: runner.os != 'Linux'
        run: npm run test:e2e
        env:
          CODE_VERSION: stable
          VSCODE_TEST_VERSION: stable
          NODE_OPTIONS: --max-old-space-size=6144

  # Artifact job - only on master or tags
  artifact:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/master' || startsWith(github.ref, 'refs/tags/')
    timeout-minutes: 10

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Node
        uses: actions/setup-node@v6
        with:
          node-version: "20.x"
          cache: "npm"

      - name: Install Dependencies
        run: npm ci

      - name: Build extension
        run: npm run build

      - name: Package extension
        run: npx @vscode/vsce package -o sven.vsix

      - name: Upload artifact
        uses: actions/upload-artifact@v5
        with:
          name: "sven-${{ github.sha }}.vsix"
          path: "sven.vsix"
